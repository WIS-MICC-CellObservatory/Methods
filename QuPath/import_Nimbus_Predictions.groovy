/*
// ABOUT 
-----------
    imports the probabilities generated by Nimbus as new measurments to each detection 
*/

//----------------------User defined parameters ----------------------------
// Path to CSV file created by Nimbus
def path = "A:/tzlily/ZoomClass1/20240918_174255_4_rO29tA_Tzlil_FFPE_control_mice_MC38_and_AT3_wt_mice_AT3_control/nimbus_output/nimbus_cell_table.csv"
//The detections it will import are either the detections of the entire image (fullImageAnnotation = true) 
//or only those belonging to specific type of annotations, as defined in annotationToConsider variable 
annotationToConsider = "ZoomClass"
fullImageAnnotation = false

//---------------------- Constants -----------------------------------
NimbusSuffix = " Probability (Nimbus)"
WholeTissueClass = "Whole Tissue Class"
delim = "," // Color separator
mappingMeasurment = 'Instance'

ProcessImage(path)

def ProcessImage(path){

    println("Importing file: "+path)
    //read file header and data
    def lines = new File(path).readLines()
    def header = lines.pop().split(delim)

    annotations = GetAnnotations(fullImageAnnotation, annotationToConsider, false)
    
    // Get a map from detection/cell mappingMeasurment to detection
    def cells = getCellObjects()
    //def cellsById = cells.groupBy(c -> c.getID().toString())

    hierarchy = getCurrentHierarchy()
    for(def a in annotations){
        cells = hierarchy.getObjectsForROI(null, a.getROI()).findAll { it.isDetection() }
        def cellsByInstance = cells.groupBy(c -> c.getMeasurementList().get(mappingMeasurment).toInteger())
        importNimbusPredictions(cellsByInstance,header,lines)
    }
    RemoveFullImageAnnotation(annotations, fullImageAnnotation)
    return true
}

def importNimbusPredictions(cellsByInstance,header,lines){
    // Handle each line
    for (def line in lines) {
        def map = lineToMap(header, line.split(delim))
        //def id = map['label']
        //def cell = cellsById[id]
        def instance = map['label'].toInteger()
        //println "instance ${instance.toString()}"
        def cell = cellsByInstance[instance]
       // println "instance=" + instance + ", id=" + cell.getID()    
        if (cell == null) {
         //   println "WARN: No cell found for $instance"
            continue
        } else if (cell.size() != 1) {
            println "WARN: ${cell.size()} cells for $instance - will skip"
            continue
        }
        else{
            //println "all is well for object id: ${cell[0].getID()}"
            ml =  cell[0].getMeasurementList()
            for(def h in header){
                if(h != 'label' && map[h].isNumber()){
                   ml.put(h+" Probability (Nimbus)", map[h].toDouble())
                }
            }
        }
    }
}

// Helper function to create a map from column headings -> values
Map lineToMap(String[] header, String[] content) {
    def map = [:]
    if (header.size() != content.size()) {
        throw new IllegalArgumentException("Header length doesn't match the content length!")
    }
    for (int i = 0; i < header.size(); i++)
        map[header[i]] = content[i]
    return map
}

def RemoveFullImageAnnotation(annotations, fullImageAnnotation){
    if(fullImageAnnotation){
        //remove the created whole image annotation 
        annotations.each{
            removeObject(it,true)
        }
    }
}

def GetAnnotations(fullImageAnnotation, annotationToConsider, selectAnotations){
    if(fullImageAnnotation){
        createFullImageAnnotation(true)
        //pathClass = getPathClass(WholeTissueClass)
        pathClass = WholeTissueClass
        annotations = getSelectedObjects()
        annotations.each{
            it.setPathClass(pathClass)
        }
    }
    else{
        annotations = getAnnotationObjects().findAll { it.getPathClass() == getPathClass(annotationToConsider) }
        if(annotations.size() == 0){
            println "No annotations of class $annotationToConsider were found"
        }
        pathClass = getPathClass(annotationToConsider)
        pathClass = annotationToConsider
    }
    if(selectAnotations){
        selectObjectsByClassification(pathClass)
    }
    return annotations
}